<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Apply a function to layers of a SpatRaster, or sub-datasets of a SpatRasterDataset — lapp • terra</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Apply a function to layers of a SpatRaster, or sub-datasets of a SpatRasterDataset — lapp"><meta property="og:description" content="Apply a function to a SpatRaster, using layers as arguments.
The number of arguments in function fun must match the number of layers in the SpatRaster (or the number of sub-datasets in the SpatRasterDataset). For example, if you want to multiply two layers, you could use this function: fun=function(x,y){return(x*y)} percentage: fun=function(x,y){return(100 * x / y)}. If you combine three layers you could use fun=function(x,y,z){return((x + y) * z)}
Before you use the function, test it to make sure that it is vectorized. That is, it should work for vectors longer than one, not only for single numbers. The function must return the same number of elements as its input vectors, or multiples of that. Also make sure that the function is NA-proof: it should returns the same number of values when some or all input values are NA. And the function must return a vector or a matrix, not a data.frame.
Use app for summarize functions such as sum, that take any number of arguments; and tapp to do so for groups of layers."><meta property="og:image" content="/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">terra</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.5-40</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/rspatial/terra/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Apply a function to layers of a SpatRaster, or sub-datasets of a SpatRasterDataset</h1>
    
    <div class="hidden name"><code>lapp.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Apply a function to a SpatRaster, using layers as arguments.</p>
<p>The number of arguments in function <code>fun</code> must match the number of layers in the SpatRaster (or the number of sub-datasets in the SpatRasterDataset). For example, if you want to multiply two layers, you could use this function: <code>fun=function(x,y){return(x*y)}</code> percentage: <code>fun=function(x,y){return(100 * x / y)}</code>. If you combine three layers you could use <code>fun=function(x,y,z){return((x + y) * z)}</code></p>
<p>Before you use the function, test it to make sure that it is vectorized. That is, it should work for vectors longer than one, not only for single numbers. The function must return the same number of elements as its input vectors, or multiples of that. Also make sure that the function is NA-proof: it should returns the same number of values when some or all input values are <code>NA</code>. And the function must return a vector or a matrix, not a <code>data.frame</code>.</p>
<p>Use <code><a href="app.html">app</a></code> for summarize functions such as <code>sum</code>, that take any number of arguments; and <code><a href="tapp.html">tapp</a></code> to do so for groups of layers.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="co"># S4 method for SpatRaster</span>
<span class="fu">lapp</span><span class="op">(</span><span class="va">x</span>, <span class="va">fun</span>, <span class="va">...</span>, usenames<span class="op">=</span><span class="cn">FALSE</span>, cores<span class="op">=</span><span class="fl">1</span>, filename<span class="op">=</span><span class="st">""</span>, overwrite<span class="op">=</span><span class="cn">FALSE</span>, wopt<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co"># S4 method for SpatRasterDataset</span>
<span class="fu">lapp</span><span class="op">(</span><span class="va">x</span>, <span class="va">fun</span>, <span class="va">...</span>, recycle<span class="op">=</span><span class="cn">FALSE</span>, filename<span class="op">=</span><span class="st">""</span>, overwrite<span class="op">=</span><span class="cn">FALSE</span>, wopt<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>x</dt>
<dd><p>SpatRaster or SpatRasterDataset</p></dd>
<dt>fun</dt>
<dd><p>a function that takes a vector and can be applied to each cell of <code>x</code></p></dd>
<dt>...</dt>
<dd><p>additional arguments to be passed to <code>fun</code></p></dd>
<dt>usenames</dt>
<dd><p>logical. Use the layer names to match the function arguments? If <code>FALSE</code> matching is by position</p></dd>
<dt>cores</dt>
<dd><p>positive integer. If <code>cores &gt; 1</code>, a 'parallel' package cluster with that many cores is created and used. You can also supply a cluster object</p></dd>
<dt>recycle</dt>
<dd><p>logical. Recycle layers to match the subdataset with the largest number of layers</p></dd>
<dt>filename</dt>
<dd><p>character. Output filename</p></dd>
<dt>overwrite</dt>
<dd><p>logical. If <code>TRUE</code>, <code>filename</code> is overwritten</p></dd>
<dt>wopt</dt>
<dd><p>list with named options for writing files as in <code><a href="writeRaster.html">writeRaster</a></code></p></dd>
</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>SpatRaster</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code> <a href="app.html">app</a>, <a href="tapp.html">tapp</a>,  <a href="math-generics.html">math</a></code></p></div>
    </div>
    <div id="note">
    <h2>Note</h2>
    <p>Use <code><a href="sapp.html">sapp</a></code> or <code>lapply</code> to apply a function that takes a SpatRaster as argument to each layer of a SpatRaster (that is rarely necessary).</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="rast.html">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"ex/logo.tif"</span>, package<span class="op">=</span><span class="st">"terra"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>  </span>
<span class="r-in"><span class="va">ss</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">[[</span><span class="fl">2</span><span class="op">:</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">fvi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">{</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">y</span> <span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="va">y</span><span class="op">)</span> <span class="op">}</span> </span>
<span class="r-in"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">lapp</span><span class="op">(</span><span class="va">ss</span>, fun<span class="op">=</span><span class="va">fvi</span> <span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># which is the same as supplying the layers to "fun"</span></span>
<span class="r-in"><span class="co"># in some cases this will be much faster </span></span>
<span class="r-in"><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">fvi</span><span class="op">(</span><span class="va">s</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">f2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">z</span><span class="op">)</span><span class="op">{</span> <span class="op">(</span><span class="va">z</span> <span class="op">-</span> <span class="va">y</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="va">y</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">}</span> </span>
<span class="r-in"><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">lapp</span><span class="op">(</span><span class="va">s</span>, fun<span class="op">=</span><span class="va">f2</span> <span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">lapp</span><span class="op">(</span><span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">f2</span>, z<span class="op">=</span><span class="fl">200</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># the usenames argument</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">fvi2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">red</span>, <span class="va">green</span><span class="op">)</span><span class="op">{</span> <span class="op">(</span><span class="va">red</span> <span class="op">-</span> <span class="va">green</span> <span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">red</span> <span class="op">+</span> <span class="va">green</span><span class="op">)</span> <span class="op">}</span> </span>
<span class="r-in"><span class="fu"><a href="names.html">names</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "red"   "green" "blue" </span>
<span class="r-in"><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu">lapp</span><span class="op">(</span><span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">fvi2</span>, usenames<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span class="r-in"><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu">lapp</span><span class="op">(</span><span class="va">s</span><span class="op">[[</span><span class="fl">2</span><span class="op">:</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">fvi2</span>, usenames<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span class="r-in"><span class="co"># x1 and x2 are the same, despite the change in the order of the layers</span></span>
<span class="r-in"><span class="co"># x4 is also the same, but x3 is not</span></span>
<span class="r-in"><span class="va">x3</span> <span class="op">&lt;-</span> <span class="fu">lapp</span><span class="op">(</span><span class="va">s</span><span class="op">[[</span><span class="fl">2</span><span class="op">:</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">fvi2</span>, usenames<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span class="r-in"><span class="va">x4</span> <span class="op">&lt;-</span> <span class="fu">lapp</span><span class="op">(</span><span class="va">s</span>, <span class="va">fvi2</span>, usenames<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># while this would fail because </span></span>
<span class="r-in"><span class="co"># there are too many layers in s</span></span>
<span class="r-in"><span class="co"># x5 &lt;- lapp(s, fvi2, usenames=FALSE)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="fu"><a href="pairs.html">pairs</a></span><span class="op">(</span><span class="fu"><a href="c.html">c</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span>, <span class="va">x3</span>, <span class="va">x4</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-plt img"><img src="lapp-1.png" alt="" width="700" height="433"></span>
<span class="r-in"></span>
<span class="r-in"><span class="co">## SpatRasterDataset</span></span>
<span class="r-in"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="sds.html">sds</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">+</span><span class="fl">50</span><span class="op">)</span></span>
<span class="r-in"><span class="fu">lapp</span><span class="op">(</span><span class="va">x</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="va">x</span><span class="op">/</span><span class="va">y</span>, recycle<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> class       : SpatRaster </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> dimensions  : 77, 101, 3  (nrow, ncol, nlyr)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> resolution  : 1, 1  (x, y)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> extent      : 0, 101, 0, 77  (xmin, xmax, ymin, ymax)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> coord. ref. : +proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> source      : memory </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> names       :      lyr.1,      lyr.2,      lyr.3 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> min values  : 0.01960784, 0.01851852, 0.01694915 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> max values  :  0.8366013,  0.8857143,  1.1235955 </span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Robert J. Hijmans.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

      </footer></div>

  


  

  </body></html>

